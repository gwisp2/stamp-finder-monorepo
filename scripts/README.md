# Stamp finder scripts
## Что это?
Скрипты для обновления [данных](https://github.com/gwisp2/russian-stamps) для [Stamp Finder](https://github.com/gwisp2/stamp-finder).

## Как их установить?
> python ./setup.py install

## Подготовка данных для Stamp Finder
```
shops.json
stamps.json
images/
|- 1537.png
|- 160.png
|- ...
```

Основу данных составляет [этот репозиторий](https://github.com/gwisp2/russian-stamps).
В нём есть всё, кроме текущей информации о наличии марок в магазинах (`shops.json`).

### Подготовка shops.json

Для создания `shops.json` необходимо выполнить следующие шаги.
Подразумевается, что репозиторий с данными склонирован в рабочую директорию, то есть существует файл `./stamps.json`.
1. Подготовить каталог для временных данных
   ```commandline
   mkdir internal
   mkdir internal/shops
   ```
2. Спарсить информацию с сайта rusmarka.ru. Страниц много, поэтому придётся подождать.
    ```
    sfs shops scrape --out=internal/shops/rusmarka.json
    ```
3. Спарсить данные по филиалам в регионах из .xls-файлов. Эти файлы отправляют некоторые филиалы, если их попросить.
    ```
    sfs shops parse-xls --out=internal/shops/smolensk.json smolensk.xls
    ```
4. Создать файл со списком магазинов `internal/shops-metadata.json`. 
   За основу можно взять [этот файл](src/sfs/core/data/default-shops-metadata.json).
   excelName - это то, как магазин назван в .xls-файле, а в случае парсинга с сайта excelName=rusmarka.ru.
   Сопоставление данных из `internal/shops` и списком магазинов производится по excelName. 
   
5. Собрать информацию по магазинам в один файл. `*` в следующей команде должен обрабатываться командной оболочкой, а не sfs.
   ```
   sfs shops join --metadata=internal/shops-metadata.json --out=shops.json internal/shops/*.json
   ```

### Дополнительные действия
Перед деплоем на прод рекомендуется выполнить следующие действия. 
1. Подготовить изображения: уменьшить размер, преобразовать в webp с потерями, добавить хэш в название файла
   ```
   sfs images build --size=512 --src-db=. --dst-db=../built-stamps
   ```
   
## Обновление данных
Эти шаги выполняются периодически в github actions, при необходимости создавая pull request в репозиторий с данными.
Поэтому, если периодически загружать данные из соответствующего репозитория, эти шаги не нужны. 

1. Парсинг новых марок с сайта rusmarka.ru. В случае обнаружения новых марок, будет обновлён файл `stamps.json` и будут загружены изображения.
   Парсинг может выдать неверные или неполные данные, поэтому результат нужно проверять вручную.
   ```
   sfs stamps scrape-new --db=.
   ```
2. Парсинг категорий с сайта. Обычно в этом шаге нет необходимости, так как обновление 
   категорий автоматически происходит при `scrape-new`, если обнаружены новые марки.  
   ```
   stamps scrape-categories --db=.
   ```
3. Переформатирование файла `stamps.json`.
   Файл будет переформатирован, марки будут находиться в порядке их номера.
   ```
   sfs stamps reformat --db=. 
   ```